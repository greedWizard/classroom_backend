# Репозиторий с исходным кодом бэк-энда classroom

## Стэк

### Основа

python3.8+

FastAPI - https://fastapi.tiangolo.com/ (Основной веб фреймворк)

Tortoise-ORM - https://tortoise-orm.readthedocs.io/en/latest/examples/fastapi.html (Асинхронная ORM)

pydantic - https://pydantic-docs.helpmanual.io/ (Сериализация, схемы)

aerich - https://ashfakmeethal.medium.com/tortoise-orm-migrations-with-aerich-5ebb7238bed5 (Миграции, но к сожалению пока что очень сырая штука :( )

### Тестирование

pytest - https://docs.pytest.org/en/6.2.x/contents.html (Основной фреймворк для тестов)

faker - https://zetcode.com/python/faker/ (Фейковые данные)

Актуальные версии всех библиотек указаны в requirements.txt

## Развернуть проект

### Локально

0. Заранее создать базу в PostgreSQL и прописать данные с пользователем, самой бд и портами в
```src/core/config/.env``` примеры можно брать из ```.envexample``` в той же директории.

1. Установить виртуальное окружение

* ```sudo apt-get update && sudo apt-get -y upgrade```

* ```sudo-apt-get install -y python3-venv```

* ```python3 -m venv venv```

* ```source venv/bin/activate```

* ```pip3 install --upgrade pip```

* ```pip3 install -r requirements.txt```

2. Перейти в ```/src```

* (Желательно) Прогнать тесты, убедиться что всё работает: ```pytest```

* Если всё нормально, там же в папке ```/src``` - ```uvicorn app:app --reload```

### В докере
0. Выполнить шаг 0 в локальной настройке, только в отдельном контейнере постгреса.

* ```sudo apt-get update && sudo apt-get -y upgrade```
* ```sudo-apt-get install docker docker-compose```
* ```docker run --rm -ti -p 8000:8000 --name homework homework/homework_back:latest```

## Миграции

### Локально

* С установленными пакетами и активированным виртуальным окружением:
(После изменений в моделях) ``` aerich migrate --name <Имя миграции, например "добавлено поле email"> ```

* (Обязательно) Перепроверить правильность миграции в ```./migrations```

* После предыдущего пункта: ```aerich upgrade```

* (Если что-то пошло не так) ```aerich downgrade``` - откатывает миграции

### В докере

* ```docker ps``` - скопировать id контейнера с запущенным бэком. Повторить предыдущий шаг через ```docker exec -it {id контейнера} <команда>```

# TODO:

* Добавить тесты на вложения (создание, удаление, получение)
* Нагрузочное тестирование, убрать лишние запросы в бд
* Логирование, возможно подключить сентри
* В тестирование добавить фабрики или любой другой автоматический генератор объектов. Создавать модели в ручную с таким количеством m2m связей очень утомительно.
* Улучшить DI, возможно даже полностью избавиться от стандартного Dapands FastAPI и перейти на ```dependency_injector```
* Pre-commit: Black и isort сводят меня с ума, надо что-то сделать с ними, ибо длинная строка с одним импортом просто напросто не даёт сделать коммит
* Создавать диалог может только ученик с преподавателем, надо запрещать всем подряд начинать диалоги с кем попало
* Переделать чат на вебсокетах? Слишком большое количество подключений одновременно не убьёт сервер?
* Убрать AuthorMixin, вместо этого переделать его под .set_user(user)
* Проверить везде DI, не создавать нигде объекты вручную (возможно только тесты)
* Почистить ненужные методы в сервисах и моделях
